#!/bin/bash
# Stop all running VirtualBox VMs before shutdown

echo "Checking for running VMs..."

# Get list of running VMs
RUNNING_VMS=$(VBoxManage list runningvms | awk -F'"' '{print $2}')

if [ -z "$RUNNING_VMS" ]; then
    echo "No running VMs found."
    exit 0
fi

echo "Running VMs found:"
echo "$RUNNING_VMS"
echo ""

# Send ACPI shutdown signal to all running VMs
echo "Sending ACPI shutdown signal to all VMs..."
while IFS= read -r vm; do
    echo "  - Shutting down: $vm"
    VBoxManage controlvm "$vm" acpipowerbutton 2>/dev/null
done <<< "$RUNNING_VMS"

# Wait for VMs to shut down gracefully
echo ""
echo "Waiting 10 seconds for graceful shutdown..."
sleep 10

# Check if any VMs are still running and force poweroff if needed
STILL_RUNNING=$(VBoxManage list runningvms | awk -F'"' '{print $2}')

if [ -n "$STILL_RUNNING" ]; then
    echo ""
    echo "Force powering off remaining VMs..."
    while IFS= read -r vm; do
        echo "  - Force poweroff: $vm"
        VBoxManage controlvm "$vm" poweroff 2>/dev/null
    done <<< "$STILL_RUNNING"
    sleep 2
fi

echo ""
echo "All VMs stopped."
